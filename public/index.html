<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gerichte für 5.–</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/app/assets/app.css" rel="stylesheet">
</head>

<body>
    <header class="bg-white border-bottom">
        <div class="container-narrow d-flex align-items-center gap-2 py-2">
            <i class="bi bi-basket2-fill fs-4 text-primary"></i>
            <strong>Gerichte für 5.–</strong>
            <span class="ms-auto badge text-bg-light">CHF 100/Woche</span>
        </div>
    </header>

    <main class="container-narrow py-3">
        <!-- Wochenplan -->
        <section id="view-plan" class="mb-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="mb-0">Wochenplan</h5>
                <button id="btn-replan" class="btn btn-sm btn-success">
                    <i class="bi bi-arrow-repeat"></i> Neu planen
                </button>
            </div>
            <div id="recipe-grid" class="recipe-grid"></div>
        </section>

        <!-- Einkaufsliste -->
        <section id="view-einkauf">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="mb-0">Einkaufsliste</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary active" type="button">Beste Preise</button>
                    <button class="btn btn-sm btn-outline-secondary" type="button">Pro Laden</button>
                </div>
            </div>

            <div class="app-card" id="list-box"><!-- Items werden hier gerendert --></div>

            <div class="d-flex justify-content-between align-items-center mt-3" id="list-summary">
                <!-- Summe wird hier gesetzt -->
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Rezepte laden
            fetch('/api/recipes')
                .then(r => r.json())
                .then(list => {
                    const g = document.getElementById('recipe-grid');
                    g.innerHTML = list.map(r => `
          <div class="app-card">
            <div class="d-flex align-items-start gap-2">
              <h6 class="mb-1 flex-grow-1">${r.title}</h6>
              <span class="price-badge">CHF ${Number(r.price_per_portion).toFixed(2)}/Port.</span>
            </div>
            <p class="text-secondary small mb-2">${r.time} min · ${r.kcal} kcal</p>
            <div class="mt-auto d-flex gap-2">
              <a href="#" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> Details</a>
              <button class="btn btn-sm btn-primary"><i class="bi bi-shuffle"></i> Tauschen</button>
            </div>
          </div>
        `).join('');
                })
                .catch(() => {
                    document.getElementById('recipe-grid').innerHTML =
                        '<div class="app-card">Fehler beim Laden.</div>';
                });

            // Einkaufsliste laden
            async function loadList() {
                try {
                    const d = await (await fetch('/api/shopping-lists')).json();
                    const box = document.getElementById('list-box');
                    const sum = document.getElementById('list-summary');

                    box.innerHTML = d.items.map(i => `
          <div class="form-check list-tick mb-2">
            <input class="form-check-input me-2" type="checkbox" id="i${i.id}">
            <label class="form-check-label" for="i${i.id}">
              ${i.qty}× ${i.name} <span class="text-secondary">· CHF ${Number(i.price).toFixed(2)}</span>
            </label>
            <span class="badge text-bg-light float-end">${i.store}</span>
          </div>
        `).join('');

                    sum.innerHTML = `
          <strong>Summe:</strong>
          <span class="ms-2 text-success fw-semibold">CHF ${Number(d.sum).toFixed(2)}</span>
        `;
                } catch (e) {
                    document.getElementById('list-box').innerHTML = '<div class="app-card">Fehler beim Laden.</div>';
                }
            }
            loadList();

            // Neu planen (Demo)
            const btn = document.getElementById('btn-replan');
            if (btn) {
                btn.addEventListener('click', async () => {
                    try {
                        const res = await fetch('/api/planner/run', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ budget: 100 })
                        });
                        const data = await res.json();
                        console.log('Planner:', data);
                        // Hier könntest du später meals neu rendern / Summe aktualisieren.
                    } catch (e) {
                        console.error('Planner Fehler', e);
                    }
                });
            }
        });
    </script>
</body>

</html>